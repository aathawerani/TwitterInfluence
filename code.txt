seq = [1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 15 1 1 1 1 1 11 1 1 1 1 1 5 1 1 9 1 1 1 1 5 1 3 1 1 1 5 1 5 13 14 13 1 5 7 5 1 5 5 11 1 13 11 13 1 13 7 13 15 1 16];
e = [0.0944368735775355 0.0509171944732617 0.123398407664758 0.0944469625786235 0.054626718027457 0.0932900477684474 0.0844981373216042 0.0665958909062684 0.0142995377591064 0.0363563168278556 0.0623032358948036 0.0317362517785866 0.036216305640498 0.0995334381235709 0.0355401916441887 0.0218044900134347;
0.00398752640701196 0.103405882118801 0.0143536315850522 0.0929036192197402 0.103450152933411 0.0331556753757311 0.0690314553567442 0.0654980954560127 0.119168303776473 0.00723128857999295 0.110195101074061 0.0678662894736265 0.0864804140019498 0.0485069611195037 0.0523396950399332 0.022425908481956;
0.0474169714716521 0.0495179112630541 0.0134019885673374 0.132391671913905 0.138362751237223 0.0818830599471615 0.0437886953542009 0.0350883686972805 0.0155800380724838 0.0393085051877844 0.106266740946275 0.0532900724735193 0.0775230204772099 0.107555204608425 0.0168744217962511 0.0417505779862374;
0.00506294647011492 0.00103987725373562 0.00477235290412233 0.0640333984704979 0.0464028551887476 0.121212736309653 0.0703645892057115 0.11986363932659 0.03082590826884 0.00654871821396596 0.0769845023799832 0.0813926781649069 0.139972868154573 0.102242549708779 0.0672327951863907 0.0620475847933892];
tr = [0.649702308603654 0.350297691396346 0 0;
0.0327525531904582 0.849350275987306 0.117897170822235 0;
0 0.253532910624893 0.0686185075858351 0.677848581789272;
0 0 0.0693597963655501 0.93064020363445];

numStates = size(tr,1);
numSymbols = size(e,2);
numEmissions = size(e,2);
seq = [numSymbols+1, seq ];
L = length(seq);

fs = zeros(numStates,L);
fs(1,1) = 1;  % assume that we start in state 1.
s = zeros(1,L);
s(1) = 1;
for count = 2:L
    for state = 1:numStates
        fs(state,count) = e(state,seq(count)) .* (sum(fs(:,count-1) .*tr(:,state)));
    end
    % scale factor normalizes sum(fs,count) to be 1. 
    s(count) =  sum(fs(:,count));
    fs(:,count) =  fs(:,count)./s(count);
end
%display(fs);

bs = ones(numStates,L);
for count = L-1:-1:1
	display(count);
    for state = 1:numStates
      bs(state,count) = (1/s(count+1)) * sum( tr(state,:)'.* bs(:,count+1) .* e(:,seq(count+1))); 
	  %if(count>60)
		%display(seq(count+1));
		%display(e(:,seq(count+1)));
		%display(bs(:,count+1));
		%display(tr(state,:)');
		%display(sum( tr(state,:)'.* bs(:,count+1) .* e(:,seq(count+1))));
		%display((1/s(count+1)));
		%display(bs(state,count));
	  %end
    end
end
%display(bs);
pSeq = sum(log(s));
pStates = fs.*bs;
%display(pStates)

% get rid of the column that we stuck in to deal with the f0 and b0 
pStates(:,1) = [];
display(pStates)
display(pSeq);
